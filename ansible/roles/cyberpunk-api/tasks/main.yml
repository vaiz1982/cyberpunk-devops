---
- name: Install system dependencies
  apt:
    name:
      - git
      - python3-venv
      - python3-pip
      - nginx
      - mariadb-server
      - mariadb-client
    state: present
    update_cache: yes

- name: Create development user
  user:
    name: "{{ dev_user }}"
    uid: "{{ dev_user_uid }}"
    group: "{{ dev_user_gid }}"
    shell: /bin/bash
    system: yes
    create_home: yes

- name: Create application directory
  file:
    path: "{{ app_dir }}"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0755'

- name: Clone repository
  git:
    repo: "{{ repo_url }}"
    dest: "{{ app_dir }}"
    version: master
    force: yes
  become_user: "{{ app_user }}"

- name: Set up directory permissions
  file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: "{{ item.mode }}"
  loop:
    - { path: "{{ app_dir }}/api", owner: "{{ app_user }}", group: "{{ app_group }}", mode: "0755" }
    - { path: "{{ app_dir }}/static", owner: "{{ app_user }}", group: "{{ app_group }}", mode: "0755" }
    - { path: "{{ app_dir }}/logs", owner: "{{ app_user }}", group: "adm", mode: "0755" }
    - { path: "{{ log_dir }}", owner: "{{ app_user }}", group: "adm", mode: "0755" }

- name: Create Python virtual environment
  command: "python3 -m venv {{ app_dir }}/venv"
  args:
    creates: "{{ app_dir }}/venv/bin/activate"
  become_user: "{{ app_user }}"

- name: Install Python dependencies
  pip:
    requirements: "{{ app_dir }}/api/requirements.txt"
    virtualenv: "{{ app_dir }}/venv"
    virtualenv_python: python3
  become_user: "{{ app_user }}"

- name: Ensure MariaDB is running
  service:
    name: mariadb
    state: started
    enabled: yes

- name: Set MariaDB root password
  mysql_user:
    login_user: root
    login_password: ""
    name: root
    password: "{{ root_db_password }}"
    host: localhost
    check_implicit_admin: yes

- name: Create database
  mysql_db:
    login_user: root
    login_password: "{{ root_db_password }}"
    name: "{{ db_name }}"
    encoding: utf8mb4
    collation: utf8mb4_unicode_ci
    state: present

- name: Create database user
  mysql_user:
    login_user: root
    login_password: "{{ root_db_password }}"
    name: "{{ db_user }}"
    password: "{{ db_password }}"
    host: localhost
    priv: "{{ db_name }}.*:ALL"
    state: present

- name: Create courses table
  mysql_query:
    login_user: root
    login_password: "{{ root_db_password }}"
    db: "{{ db_name }}"
    query: |
      CREATE TABLE IF NOT EXISTS courses (
        id INT AUTO_INCREMENT PRIMARY KEY,
        name VARCHAR(255) NOT NULL,
        description TEXT,
        duration VARCHAR(50)
      );

- name: Populate courses data
  mysql_query:
    login_user: root
    login_password: "{{ root_db_password }}"
    db: "{{ db_name }}"
    query: |
      INSERT IGNORE INTO courses (name, description, duration) VALUES
      ('DevOps Fundamentals', 'Основы DevOps: CI/CD, контейнеризация, мониторинг', '8 недель'),
      ('Kubernetes Mastery', 'Продвинутый курс по оркестрации контейнеров', '12 недель'),
      ('Cloud Security', 'Безопасность в облачных средах AWS/Azure', '10 недель'),
      ('Python for DevOps', 'Автоматизация DevOps задач на Python', '6 недель'),
      ('Infrastructure as Code', 'Terraform и Ansible для управления инфраструктурой', '8 недель');

- name: Create .env file
  template:
    src: env.j2
    dest: "{{ app_dir }}/api/.env"
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0644'

- name: Configure systemd service
  template:
    src: service.j2
    dest: "/etc/systemd/system/{{ app_name }}.service"
    owner: root
    group: root
    mode: '0644'
  notify: restart app service

- name: Configure nginx
  template:
    src: nginx.conf.j2
    dest: "/etc/nginx/sites-available/{{ app_name }}"
    owner: root
    group: root
    mode: '0644'
  notify: restart nginx

- name: Enable nginx site
  file:
    src: "/etc/nginx/sites-available/{{ app_name }}"
    dest: "/etc/nginx/sites-enabled/{{ app_name }}"
    state: link
  notify: restart nginx

- name: Remove default nginx site
  file:
    path: "/etc/nginx/sites-enabled/default"
    state: absent
  notify: restart nginx

- name: Enable and start application service
  systemd:
    name: "{{ app_name }}"
    enabled: yes
    state: started
    daemon_reload: yes
